<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程卷宗大師 - 自動化書背產生系統 V2.11 (雲林縣政府標準版)</title>
    
    <!-- 載入 React 核心 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 載入 Babel (用於瀏覽器端編譯 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 載入 PDF 生成工具 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* 直書設定 */
        .writing-vertical-lr {
            writing-mode: vertical-lr;
            text-orientation: upright;
            letter-spacing: 0.1em;
        }
        /* 隱藏列印時不必要的元素 */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            @page { margin: 0; }
            body { margin: 0; padding: 0; background: white; }
        }
        /* 自定義捲軸 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        /* 字體設定：優先使用標楷體 */
        body { 
            font-family: "BiauKai", "DFKai-SB", "KaiTi", "Microsoft JhengHei", serif; 
            font-weight: bold; /* 標楷體通常較細，加粗以利列印 */
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 圖標組件 (SVG) ---
        const IconFileText = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>;
        const IconTrash2 = ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const IconFolderOpen = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const IconPrinter = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>;
        const IconCloud = ({size=20}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>;
        const IconLayout = ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>;
        const IconGrid = ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>;
        const IconCopy = ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>;
        const IconType = ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>;
        const IconImage = ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>;
        const IconRefresh = ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>;

        // --- 資料定義 (依據 V2.10 需求完整擴充) ---
        const CATEGORY_DATA = {
            "MD 01設計資料": {
                name: "MD 01設計資料",
                subs: [
                    { name: "A-設計預算書圖", code: "A", subs: [] },
                    { name: "B-變更資料", code: "B", subs: [] },
                    { name: "C-設計管線調查含圖資", code: "C", subs: [] },
                    { name: "D-交維計畫", code: "D", subs: [] }
                ]
            },
            "MD 02監造執行文件": {
                name: "MD 02監造執行文件",
                subs: [
                    { 
                        name: "A-契約、開工資料", code: "A", 
                        subs: [
                            { name: "RT-1契約", code: "RT-1" },
                            { name: "RT-2開工資料", code: "RT-2" }
                        ]
                    },
                    { 
                        name: "P-計畫書", code: "P",
                        subs: [
                            { name: "S-監造計畫", code: "S" },
                            { name: "Q-整體計畫審查", code: "Q" },
                            { name: "A-分項計畫審查", code: "A" },
                            { name: "Y-材料送審資料審查", code: "Y" }
                        ]
                    },
                    { name: "G-監造日報", code: "G", subs: [] },
                    { 
                        name: "D-計畫書、材料審查意見", code: "D",
                        subs: [
                            { name: "D1-計劃書審查意見", code: "D1" },
                            { name: "D2-材料審查意見", code: "D2" }
                        ]
                    },
                    { 
                        name: "E-監造施工抽查文件", code: "E",
                        subs: [
                            { name: "E1-施工抽查", code: "E1" },
                            { name: "E2-材料設施抽查", code: "E2" },
                            { name: "E3-職業安全抽查", code: "E3" },
                            { name: "E4-環境衛生抽查", code: "E4" },
                            { name: "E5-交通維持抽查", code: "E5" },
                            { name: "E6-機械設備抽查", code: "E6" },
                            { name: "E7-機電設備抽查", code: "E7" }
                        ]
                    },
                    { 
                        name: "R-會議紀錄", code: "R",
                        subs: [
                            { name: "W-工務會議", code: "W" },
                            { name: "Q-主管機關督導", code: "Q" },
                            { name: "T-技師督導", code: "T" },
                            { name: "I-公文", code: "I" }
                        ]
                    },
                    { name: "Q-不合格缺失改善資料", code: "Q", subs: [] },
                    { name: "I-技師督導", code: "I", subs: [] },
                    { name: "J-督導、查核簡報", code: "J", subs: [] },
                    { name: "K-竣工結算資料", code: "K", subs: [] },
                    { name: "M-成果報告", code: "M", subs: [] },
                    {
                        name: "G-管線調查資料", code: "G",
                        subs: [
                            { name: "G-1管線試挖", code: "G1" },
                            { name: "G-2圖審簡報", code: "G2" },
                            { name: "G-3各管線圖資", code: "G3" }
                        ]
                    }
                ]
            },
            "MD 03承包商提供文件": {
                name: "MD 03承包商提供文件",
                subs: [
                    { 
                        name: "P-承包商計畫書", code: "P",
                        subs: [
                            { name: "Q-01施工計畫", code: "Q-01" },
                            { name: "Q-02品質計畫", code: "Q-02" },
                            { name: "Q-03職業安全衛生計畫", code: "Q-03" },
                            { name: "Q-04交維計畫", code: "Q-04" },
                            { name: "Q-05防災減災計畫", code: "Q-05" },
                            { name: "A-01各分項計劃增列", code: "A-01" }
                        ]
                    },
                    { 
                        name: "Y-材料送審資料", code: "Y",
                        subs: [
                            { name: "Y-01鋼筋材料", code: "Y-01" },
                            { name: "Y-02混凝土材料", code: "Y-02" },
                            { name: "Y-03鋼筋混凝土管材料", code: "Y-03" },
                            { name: "Y-04可控制性低強回填材料", code: "Y-04" },
                            { name: "Y-05依據不同材料增列", code: "Y-05" }
                        ]
                    },
                    { 
                        name: "G-承包商施工日誌", code: "G",
                        subs: [
                            { name: "01_施工日誌原始檔", code: "01" },
                            { name: "02_廠商簽章版", code: "02" }
                        ]
                    },
                    { name: "D-估驗計價資料", code: "D", subs: [] },
                    { name: "E-管制總表", code: "E", subs: [] }
                ]
            }
        };

        // --- 預設值設定 (DEFAULT_DATA) ---
        const DEFAULT_DATA = {
            hostName: '雲林縣政府', // 客製化預設值
            projectName: '國道1號增設銜接台74線系統交流道工程',
            caseNumber: '112-001', // 移除 "案號-" 前綴，純數字
            folderNumber: 'P-S-01', // 符合 [主類]-[次類]-[流水號]
            unitName: '睿泰工程顧問有限公司', // 客製化預設值
            category: 'S-監造計畫', // 保留代碼
            fileName: '第一版',
            spineWidth: 45, // mm
            spineHeight: 185, // mm
            unitIcon: null,
            hostIcon: null, 
            
            // 選單狀態 (儲存選到的物件 key)
            selectedSystem: "MD 02監造執行文件",
            selectedMain: "P-計畫書",
            selectedSub: "S-監造計畫",
            
            // --- 字體大小 (px) ---
            hostNameFontSize: 22,
            projectNameFontSize: 22,
            caseNumberFontSize: 14,
            categoryFontSize: 24,
            fileNameFontSize: 20,
            folderNumberFontSize: 18,
            unitNameFontSize: 16,
            
            // --- 圖片大小 (px) ---
            unitIconSize: 60,
            hostIconSize: 60,
        };

        const App = () => {
            const [labels, setLabels] = useState([
                { ...DEFAULT_DATA, id: 0 },
                { ...DEFAULT_DATA, id: 1, folderNumber: 'P-S-02' },
                { ...DEFAULT_DATA, id: 2, folderNumber: 'P-S-03' },
                { ...DEFAULT_DATA, id: 3, folderNumber: 'P-S-04' }
            ]);
            
            const [activeTab, setActiveTab] = useState(0); 
            // history 儲存 { name: string, caseNo: string }
            const [history, setHistory] = useState([]);
            const [isSaving, setIsSaving] = useState(false);
            const [libsLoaded, setLibsLoaded] = useState(false);
            const [printMode, setPrintMode] = useState('4-up'); 
            const printRef = useRef(null);

            const activeLabel = labels[activeTab];

            // 載入歷史紀錄和預設圖片
            useEffect(() => {
                const savedHistory = localStorage.getItem('projectHistory_v2'); // 使用新 key 避免衝突
                if (savedHistory) {
                    setHistory(JSON.parse(savedHistory));
                }
                
                const savedHostIcon = localStorage.getItem('defaultHostIcon');
                const savedUnitIcon = localStorage.getItem('defaultUnitIcon');
                
                if (savedHostIcon || savedUnitIcon) {
                    setLabels(prev => prev.map(lbl => ({
                        ...lbl,
                        hostIcon: savedHostIcon || lbl.hostIcon,
                        unitIcon: savedUnitIcon || lbl.unitIcon
                    })));
                }
                
                if (window.jspdf && window.html2canvas) {
                    setLibsLoaded(true);
                } else {
                    const interval = setInterval(() => {
                        if (window.jspdf && window.html2canvas) {
                            setLibsLoaded(true);
                            clearInterval(interval);
                        }
                    }, 500);
                }
            }, []);

            const updateLabel = (index, field, value) => {
                setLabels(prev => prev.map((lbl, i) => {
                    if (i !== index) return lbl;
                    return { ...lbl, [field]: value };
                }));
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                updateLabel(activeTab, name, value);
            };

            // 處理工程名稱變更，自動帶入案號
            const handleProjectNameChange = (e) => {
                const newName = e.target.value;
                updateLabel(activeTab, 'projectName', newName);
                
                // 搜尋歷史紀錄
                const found = history.find(h => h.name === newName);
                if (found) {
                    updateLabel(activeTab, 'caseNumber', found.caseNo);
                }
            };

            // 處理分類選擇變更 (三層級連動)
            const handleSystemChange = (e) => {
                const sysKey = e.target.value;
                const sysObj = CATEGORY_DATA[sysKey];
                if (!sysObj) return;

                // 預設選第一個主分類
                const firstMain = sysObj.subs[0];
                const firstMainKey = firstMain ? firstMain.name : "";
                
                // 預設選第一個次分類 (若有)
                const firstSub = firstMain && firstMain.subs.length > 0 ? firstMain.subs[0] : null;
                const firstSubKey = firstSub ? firstSub.name : "";

                updateClassification(sysKey, firstMainKey, firstSubKey);
            };

            const handleMainChange = (e) => {
                const mainKey = e.target.value;
                const sysObj = CATEGORY_DATA[activeLabel.selectedSystem];
                const mainObj = sysObj.subs.find(m => m.name === mainKey);
                
                // 預設選第一個次分類
                const firstSub = mainObj && mainObj.subs.length > 0 ? mainObj.subs[0] : null;
                const firstSubKey = firstSub ? firstSub.name : "";

                updateClassification(activeLabel.selectedSystem, mainKey, firstSubKey);
            };

            const handleSubChange = (e) => {
                updateClassification(activeLabel.selectedSystem, activeLabel.selectedMain, e.target.value);
            };

            // 更新分類邏輯與編號
            const updateClassification = (sysKey, mainKey, subKey) => {
                const newLabels = [...labels];
                const lbl = newLabels[activeTab];

                lbl.selectedSystem = sysKey;
                lbl.selectedMain = mainKey;
                lbl.selectedSub = subKey;

                // 取得代碼
                const sysObj = CATEGORY_DATA[sysKey];
                const mainObj = sysObj ? sysObj.subs.find(m => m.name === mainKey) : null;
                
                // 主類代碼
                const mainCode = mainObj ? mainObj.code : "";
                
                // 次類代碼與名稱
                let subCode = "";
                let categoryName = mainKey; // 預設顯示主分類名稱

                if (subKey) {
                    const subObj = mainObj ? mainObj.subs.find(s => s.name === subKey) : null;
                    if (subObj) {
                        subCode = subObj.code;
                        categoryName = subKey; // 若有次分類，顯示次分類名稱
                    }
                }

                // 更新顯示的分類名稱 (完整保留代碼，例如 "S-監造計畫")
                // 自動去除路徑中的分類代碼，只留顯示名稱
                // 修正：使用者希望"中間分類改為橫式，不用'-'" (V2.8)，但V2.9又說"代碼保留"。
                // V2.10 需求：顯示完整名稱 (如 E1-施工抽查)
                lbl.category = categoryName;

                // 生成編號：[主類]-[次類]-[流水號]
                // 移除代碼中的 "-" 以求簡潔 (例如 Q-01 -> Q01)
                const cleanMain = mainCode.replace(/-/g, '');
                const cleanSub = subCode.replace(/-/g, '');
                
                // 如果沒有次類，就只用主類
                const codePart = cleanSub ? `${cleanMain}-${cleanSub}` : cleanMain;
                const serial = "01"; // 預設流水號

                lbl.folderNumber = `${codePart}-${serial}`;

                setLabels(newLabels);
            };

            const handleImageUpload = (e) => {
                const { name, files } = e.target;
                const file = files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const result = reader.result;
                        updateLabel(activeTab, name, result); 
                        if (name === 'hostIcon') localStorage.setItem('defaultHostIcon', result);
                        else if (name === 'unitIcon') localStorage.setItem('defaultUnitIcon', result);
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            const handleRemoveImage = (name) => {
                updateLabel(activeTab, name, null);
                if (name === 'hostIcon') localStorage.removeItem('defaultHostIcon');
                else if (name === 'unitIcon') localStorage.removeItem('defaultUnitIcon');
            };

            const copyFirstToAll = () => {
                if (!confirm("確定複製？")) return;
                const source = labels[0];
                setLabels(prev => prev.map((lbl, i) => i === 0 ? lbl : { ...source, id: i }));
            };

            const resetToDefaults = () => {
                if (!confirm("確定重置？")) return;
                const currentId = activeLabel.id;
                const currentFolderNum = activeLabel.folderNumber;
                setLabels(prev => prev.map((lbl, i) => i !== activeTab ? lbl : { 
                    ...DEFAULT_DATA, 
                    id: currentId, 
                    folderNumber: currentFolderNum,
                    hostIcon: localStorage.getItem('defaultHostIcon'),
                    unitIcon: localStorage.getItem('defaultUnitIcon')
                }));
            };

            // 儲存歷史紀錄 (包含案號)
            const saveToHistory = () => {
                if (!activeLabel.projectName.trim()) return;
                
                // 更新或新增歷史
                const newEntry = { name: activeLabel.projectName, caseNo: activeLabel.caseNumber };
                
                // 過濾掉舊的同名紀錄，加入新的到最前面
                const filtered = history.filter(h => h.name !== activeLabel.projectName);
                const newHistory = [newEntry, ...filtered].slice(0, 15);
                
                setHistory(newHistory);
                localStorage.setItem('projectHistory_v2', JSON.stringify(newHistory));
            };
            
            const handleHistorySelect = (e) => {
                const val = e.target.value;
                if(!val) return;
                
                // 找出對應的案號
                const record = history.find(h => h.name === val);
                updateLabel(activeTab, 'projectName', val);
                if(record) {
                    updateLabel(activeTab, 'caseNumber', record.caseNo);
                }
                e.target.value = ""; // Reset
            };

            const clearHistory = () => {
                setHistory([]);
                localStorage.removeItem('projectHistory_v2');
            };

            const generatePDF = async (action = 'download') => {
                if (!printRef.current || !libsLoaded) {
                    if (!libsLoaded) alert("系統載入中...");
                    return;
                }
                setIsSaving(true);
                try {
                    saveToHistory(); // 儲存專案與案號
                    const html2canvas = window.html2canvas;
                    const { jsPDF } = window.jspdf;
                    const canvas = await html2canvas(printRef.current, { scale: 3, useCORS: true, backgroundColor: '#ffffff' });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    pdf.addImage(imgData, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
                    if (action === 'download') pdf.save(`${activeLabel.projectName}.pdf`);
                    else await uploadToGoogleDrive(pdf);
                } catch (error) {
                    console.error(error);
                    alert("錯誤");
                } finally {
                    setIsSaving(false);
                }
            };

            const uploadToGoogleDrive = async (pdfDoc) => {
                alert(`模擬上傳至 Google Drive: ${activeLabel.projectName}`);
                pdfDoc.save(`${activeLabel.projectName}-Backup.pdf`);
            };

            // 書背渲染組件
            const SpineLabel = ({ data }) => (
                <div 
                    className="border-2 border-black flex flex-col items-center justify-between text-center relative bg-white overflow-hidden shadow-sm"
                    style={{
                        width: `${data.spineWidth}mm`,
                        height: `${data.spineHeight}mm`,
                        padding: '2mm 1mm',
                        boxSizing: 'border-box'
                    }}
                >
                    {/* 1. 主辦單位 + Logo */}
                    <div className="w-full flex flex-col justify-end items-center border-b-2 border-black pb-1 mb-1 min-h-[15%]">
                        {data.hostIcon && (
                            <img src={data.hostIcon} className="object-contain mb-1" style={{ width: `${data.hostIconSize}px` }} />
                        )}
                        <h3 className="font-bold w-full break-words leading-tight whitespace-pre-wrap" style={{ fontSize: `${data.hostNameFontSize}px` }}>
                            {data.hostName}
                        </h3>
                    </div>

                    {/* 2. 工程名稱 + 案號 (純數字) */}
                    <div className="w-full flex flex-col border-b-2 border-black mb-1 min-h-[18%]">
                        <div className="w-full flex-grow flex items-center justify-center py-2 px-1">
                            <h3 className="font-bold w-full break-words leading-tight whitespace-pre-wrap text-center" style={{ fontSize: `${data.projectNameFontSize}px` }}>
                                {data.projectName}
                            </h3>
                        </div>
                        {data.caseNumber && (
                            <>
                                <div className="w-full border-t-2 border-black"></div>
                                <div className="w-full py-1 text-center">
                                    <h3 className="font-bold w-full break-words leading-tight" style={{ fontSize: `${data.caseNumberFontSize}px` }}>
                                        {/* 直接顯示案號，不加"案號-" */}
                                        {data.caseNumber}
                                    </h3>
                                </div>
                            </>
                        )}
                    </div>

                    {/* 3. 中間核心 */}
                    <div className="flex-1 w-full flex flex-col items-center justify-between">
                        <div className="flex flex-col items-center gap-2 flex-grow justify-start py-2 pt-2">
                            <div 
                                className="font-black tracking-widest py-2 px-1 flex items-center justify-center whitespace-pre-wrap text-center"
                                style={{ fontSize: `${data.categoryFontSize}px` }}
                            >
                                {data.category}
                            </div>
                            <div 
                                className="font-bold writing-vertical-lr tracking-wider text-slate-800 whitespace-pre-wrap"
                                style={{ fontSize: `${data.fileNameFontSize}px` }}
                            >
                                {data.fileName}
                            </div>
                        </div>
                        <div className="w-full border-t-2 border-black pt-1 mt-1 text-center">
                            <div className="font-mono font-bold whitespace-pre-wrap" style={{ fontSize: `${data.folderNumberFontSize}px` }}>
                                {data.folderNumber}
                            </div>
                        </div>
                    </div>

                    {/* 4. 單位資訊 */}
                    <div className="w-full flex flex-col justify-start items-center border-t-2 border-black pt-1 mt-1 min-h-[15%]">
                        <h4 className="font-bold mb-1 whitespace-pre-wrap" style={{ fontSize: `${data.unitNameFontSize}px` }}>{data.unitName}</h4>
                        {data.unitIcon && (
                            <img src={data.unitIcon} className="object-contain" style={{ width: `${data.unitIconSize}px` }} />
                        )}
                    </div>
                </div>
            );

            // 控制面板元件 (省略部分樣式以節省空間，功能不變)
            const FontSizeControl = ({ label, field, value, min=10, max=60 }) => (
                <div className="flex items-center justify-between gap-2 mb-1">
                    <label className="text-xs text-slate-500 w-24 flex-shrink-0">{label}</label>
                    <input type="range" min={min} max={max} value={value} onChange={(e) => updateLabel(activeTab, field, Number(e.target.value))} className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                    <span className="text-xs text-slate-500 w-6 text-right">{value}</span>
                </div>
            );

            return (
                <div className="min-h-screen font-sans text-slate-800 flex flex-col md:flex-row">
                    <div className="w-full md:w-1/3 bg-white shadow-xl p-6 overflow-y-auto h-screen z-10 no-print">
                        <div className="mb-4 border-b pb-4">
                            <h1 className="text-2xl font-bold text-blue-800 flex items-center gap-2">
                                <IconFileText /> 工程卷宗大師
                            </h1>
                            <p className="text-sm text-slate-500 mt-1">V2.11 雲林縣政府標準版</p>
                        </div>

                        {/* 標籤 Tabs */}
                        <div className="flex gap-1 mb-4 border-b border-slate-200 pb-1 overflow-x-auto">
                            {labels.map((_, idx) => (
                                <button key={idx} onClick={() => setActiveTab(idx)} className={`px-4 py-2 text-sm font-bold rounded-t-lg transition whitespace-nowrap ${activeTab === idx ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-600'}`}>標籤 {idx + 1}</button>
                            ))}
                        </div>

                        <div className="space-y-4 pb-20">
                            {/* 主辦 & 工程 & 案號 */}
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-slate-500">主辦單位</label>
                                <input type="text" name="hostName" value={activeLabel.hostName} onChange={handleInputChange} className="w-full p-2 border rounded text-sm" />
                            </div>
                            <div className="space-y-2">
                                <div className="flex justify-between"><label className="text-xs font-bold text-slate-500">工程名稱</label><button onClick={clearHistory} className="text-xs text-red-400 flex items-center gap-1"><IconTrash2 size={10}/>清除紀錄</button></div>
                                <textarea name="projectName" value={activeLabel.projectName} onChange={handleProjectNameChange} rows="2" className="w-full p-2 border rounded text-sm resize-none" />
                                {history.length > 0 && (
                                    <select onChange={handleHistorySelect} className="w-full p-1 text-xs border rounded bg-slate-50 text-slate-600">
                                        <option value="">-- 快速選取歷史工程 --</option>
                                        {history.map((h, i) => <option key={i} value={h.name}>{h.name}</option>)}
                                    </select>
                                )}
                            </div>
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-slate-500">案號 (自動帶入/手動修改)</label>
                                <input type="text" name="caseNumber" value={activeLabel.caseNumber} onChange={handleInputChange} className="w-full p-2 border rounded text-sm" placeholder="112-001" />
                            </div>

                            {/* 三層分類選單 */}
                            <div className="p-3 bg-blue-50 rounded border border-blue-100 space-y-2">
                                <div className="flex items-center gap-2 text-blue-700 font-bold text-sm"><IconFolderOpen size={16}/> 文件分類系統</div>
                                <select value={activeLabel.selectedSystem} onChange={handleSystemChange} className="w-full p-1 text-sm border rounded">
                                    {Object.keys(CATEGORY_DATA).map(k => <option key={k} value={k}>{k}</option>)}
                                </select>
                                <select value={activeLabel.selectedMain} onChange={handleMainChange} className="w-full p-1 text-sm border rounded">
                                    {CATEGORY_DATA[activeLabel.selectedSystem].subs.map(m => <option key={m.name} value={m.name}>{m.name}</option>)}
                                </select>
                                <select value={activeLabel.selectedSub} onChange={handleSubChange} className="w-full p-1 text-sm border rounded">
                                    {/* 這裡需要安全存取，因為切換主類時次類可能暫時為空或不匹配 */}
                                    {(() => {
                                        const sys = CATEGORY_DATA[activeLabel.selectedSystem];
                                        const main = sys.subs.find(m => m.name === activeLabel.selectedMain);
                                        return main && main.subs.length > 0 ? main.subs.map(s => <option key={s.name} value={s.name}>{s.name}</option>) : <option value="">(無次分類)</option>;
                                    })()}
                                </select>
                                <textarea name="category" value={activeLabel.category} onChange={handleInputChange} rows="2" className="w-full p-2 border rounded text-sm resize-none" placeholder="分類顯示名稱..." />
                            </div>

                            <div className="grid grid-cols-2 gap-2">
                                <div><label className="text-xs font-bold text-slate-500">卷宗編號</label><input type="text" name="folderNumber" value={activeLabel.folderNumber} onChange={handleInputChange} className="w-full p-2 border rounded text-sm font-mono" /></div>
                                <div><label className="text-xs font-bold text-slate-500">卷宗名稱</label><input type="text" name="fileName" value={activeLabel.fileName} onChange={handleInputChange} className="w-full p-2 border rounded text-sm" /></div>
                            </div>
                            
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-slate-500">單位名稱</label>
                                <input type="text" name="unitName" value={activeLabel.unitName} onChange={handleInputChange} className="w-full p-2 border rounded text-sm" />
                            </div>

                            {/* 設定區 */}
                            <div className="p-3 bg-slate-50 rounded border space-y-3">
                                <div className="text-sm font-bold text-slate-600 flex gap-2"><IconSettings size={16}/> 圖片與排版</div>
                                <div className="grid grid-cols-2 gap-2">
                                    <label className="cursor-pointer bg-white border p-2 rounded text-xs text-center hover:bg-slate-100">
                                        <div className="flex justify-center mb-1"><IconUpload size={14}/></div>
                                        主辦 Logo
                                        <input type="file" name="hostIcon" accept="image/*" className="hidden" onChange={handleImageUpload}/>
                                    </label>
                                    <label className="cursor-pointer bg-white border p-2 rounded text-xs text-center hover:bg-slate-100">
                                        <div className="flex justify-center mb-1"><IconUpload size={14}/></div>
                                        單位 Logo
                                        <input type="file" name="unitIcon" accept="image/*" className="hidden" onChange={handleImageUpload}/>
                                    </label>
                                </div>
                                <div className="space-y-1 pt-2 border-t">
                                    <FontSizeControl label="主辦字體" field="hostNameFontSize" value={activeLabel.hostNameFontSize} />
                                    <FontSizeControl label="工程字體" field="projectNameFontSize" value={activeLabel.projectNameFontSize} />
                                    <FontSizeControl label="分類字體" field="categoryFontSize" value={activeLabel.categoryFontSize} />
                                    <FontSizeControl label="編號字體" field="folderNumberFontSize" value={activeLabel.folderNumberFontSize} />
                                </div>
                            </div>
                            
                            <div className="flex gap-2 pt-2">
                                <button onClick={resetToDefaults} className="flex-1 py-2 bg-slate-200 hover:bg-slate-300 rounded text-sm">重置</button>
                                <button onClick={() => generatePDF('download')} className="flex-[2] py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-bold flex justify-center gap-2"><IconPrinter size={16}/> 下載 PDF</button>
                            </div>
                        </div>
                    </div>

                    {/* 預覽區 */}
                    <div className="w-full md:w-2/3 bg-slate-200 p-8 flex flex-col items-center overflow-auto">
                        <div className="flex gap-2 mb-4 bg-white p-1 rounded shadow-sm">
                            <button onClick={() => setPrintMode('single')} className={`px-3 py-1 text-sm rounded ${printMode==='single'?'bg-blue-100 text-blue-800 font-bold':''}`}>單張預覽</button>
                            <button onClick={() => setPrintMode('4-up')} className={`px-3 py-1 text-sm rounded ${printMode==='4-up'?'bg-blue-100 text-blue-800 font-bold':''}`}>A4 四聯</button>
                        </div>
                        <div className="bg-white shadow-2xl relative" style={{ width: '210mm', height: '297mm', transform: 'scale(0.8)', transformOrigin: 'top center' }}>
                            <div ref={printRef} className="w-full h-full bg-white relative">
                                {printMode === 'single' ? (
                                    <div className="w-full h-full flex justify-center items-center"><SpineLabel data={activeLabel} /></div>
                                ) : (
                                    <div className="w-full h-full flex justify-center items-center">
                                        <div className="flex gap-0 items-center justify-center">
                                            {labels.map((lbl, idx) => <SpineLabel key={lbl.id} data={lbl} />)}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
